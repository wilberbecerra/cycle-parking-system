<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel Operativo</title>
    <link rel="stylesheet" href="../css/styles.css" />
    <style>
      .badge {
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.7rem;
        font-weight: 800;
        color: white;
        text-transform: uppercase;
      }
      .badge-activo {
        background-color: #10b981;
      }
      .badge-finalizado {
        background-color: #3b82f6;
      }
      .badge-perdido {
        background-color: #ef4444;
      }

      .btn-action {
        border: none;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        margin-right: 4px;
        color: white;
        font-size: 1rem;
      }
      .btn-edit {
        background-color: #0ea5e9;
      }
      .btn-out {
        background-color: #f59e0b;
      }
      .btn-loss {
        background-color: #ef4444;
      }

      .camera-container {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }
      .video-box {
        width: 50%;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
        position: relative;
        height: 200px;
      }
      .video-box video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .photo-preview {
        width: 50%;
        background: #f1f5f9;
        border-radius: 8px;
        height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px dashed #cbd5e1;
      }
      .photo-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-logo-section">
        <img src="../assets/logo-login.png" alt="Logo" class="header-logo" />
        <div class="header-title">üö≤ <strong>Parking Control</strong></div>
      </div>
      <div class="header-tools">
        <button
          id="btn-admin-usuarios"
          onclick="abrirModalUsuarios()"
          style="background: #8b5cf6; display: none"
        >
          üë• Usuarios
        </button>
        <button onclick="abrirHistorial()" style="background: #64748b">
          üìú Historial Turno
        </button>
        <button onclick="ejecutarCorte('X')" style="background: var(--info)">
          Corte X
        </button>
        <button
          onclick="ejecutarCorte('Z')"
          style="background: var(--primary); border: 1px solid white"
        >
          Corte Z
        </button>
        <span>Hola, <strong id="nombre-usuario">...</strong></span>
        <button onclick="cerrarSesionBoton()" style="background: var(--danger)">
          Salir
        </button>
      </div>
    </header>

    <main>
      <section id="registro-ingreso">
        <h3>üìù Registro de Ingreso</h3>
        <div class="form-grid">
          <div class="input-group">
            <label>Documento</label>
            <div style="display: flex; gap: 10px">
              <select id="tipo-doc" style="width: 90px">
                <option value="DNI">DNI</option>
                <option value="CE">CE</option>
              </select>
              <input type="text" id="documento-input" placeholder="N√∫mero" />
            </div>
          </div>
          <div class="input-group">
            <label>Nombre Cliente</label
            ><input type="text" id="nombre-cliente" />
          </div>
          <div class="input-group">
            <label>Tipo Veh√≠culo</label
            ><input list="v-list" id="tipo-vehiculo" />
          </div>
          <div class="input-group">
            <label>Marca</label><input type="text" id="marca" />
          </div>
          <div class="input-group">
            <label>Color</label><input type="text" id="color" />
          </div>
          <div class="input-group full-width">
            <label>Observaciones</label
            ><textarea id="observaciones" rows="3"></textarea>
          </div>
        </div>
        <button onclick="guardarTicket()" class="btn-primary">
          GENERAR TICKET
        </button>
      </section>

      <section>
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
          "
        >
          <h3 style="margin: 0">üö≤ Operaci√≥n Diaria (Activos)</h3>
          <input
            type="text"
            id="buscador-principal"
            placeholder="üîç Buscar..."
            autocomplete="off"
            readonly
            onfocus="this.removeAttribute('readonly')"
            oninput="filtrarTabla()"
            style="
              width: 300px;
              padding: 8px;
              border: 1px solid #cbd5e1;
              border-radius: 6px;
            "
          />
        </div>
        <div style="overflow-x: auto">
          <table>
            <thead>
              <tr>
                <th>C√≥digo</th>
                <th>Cliente</th>
                <th>Hora Ingreso</th>
                <th>Veh√≠culo</th>
                <th>Marca/Color</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tickets-body"></tbody>
          </table>
        </div>
      </section>
    </main>

    <datalist id="v-list">
      <option value="Bicicleta"></option>
      <option value="Scooter El√©ctrico"></option>
    </datalist>

    <div id="modal-editar" class="modal">
      <div class="modal-content" style="width: 500px">
        <h3>üìù Bit√°cora de Observaciones</h3>
        <p style="font-size: 0.85rem; color: #64748b">
          Los datos principales est√°n bloqueados por seguridad.
        </p>

        <input type="hidden" id="edit-id-ticket" />

        <div class="input-group">
          <label>Nombre Cliente</label>
          <input
            type="text"
            id="edit-nombre"
            class="input-bloqueado"
            readonly
          />
        </div>

        <div
          class="form-grid"
          style="grid-template-columns: 1fr 1fr; gap: 10px"
        >
          <div class="input-group">
            <label>Marca</label>
            <input
              type="text"
              id="edit-marca"
              class="input-bloqueado"
              readonly
            />
          </div>
          <div class="input-group">
            <label>Color</label>
            <input
              type="text"
              id="edit-color"
              class="input-bloqueado"
              readonly
            />
          </div>
        </div>

        <div class="input-group">
          <label style="color: var(--primary); font-weight: bold"
            >‚ûï Agregar / Editar Observaciones</label
          >
          <textarea
            id="edit-obs"
            rows="4"
            placeholder="Ej: Cliente reporta ray√≥n antiguo, Se verific√≥ cadena..."
          ></textarea>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 15px">
          <button
            onclick="guardarEdicion()"
            class="btn-primary"
            style="margin: 0"
          >
            üíæ Guardar Nota
          </button>
          <button
            onclick="cerrarModal('modal-editar')"
            style="
              background: grey;
              color: white;
              border: none;
              padding: 10px;
              border-radius: 8px;
              width: 100%;
            "
          >
            Cerrar
          </button>
        </div>
      </div>
    </div>

    <div id="modal-anulacion" class="modal">
      <div
        class="modal-content"
        style="width: 500px; border-top: 5px solid #ef4444"
      >
        <h3 style="color: #ef4444; margin-top: 0">üö® Protocolo de Anulaci√≥n</h3>
        <div
          style="
            background: #fef2f2;
            color: #991b1b;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.9rem;
            margin-bottom: 15px;
          "
        >
          ‚ö†Ô∏è Esta acci√≥n es irreversible. Se requiere autorizaci√≥n de un
          Administrador.
        </div>

        <input type="hidden" id="anular-id-ticket" />

        <div class="input-group">
          <label>Motivo de la Anulaci√≥n (*)</label>
          <textarea
            id="anular-motivo"
            rows="3"
            placeholder="Detalle la raz√≥n (Ej: Error de digitaci√≥n, Cliente se retir√≥ sin ingresar...)"
          ></textarea>
        </div>

        <hr style="border: 0.5px solid #eee; margin: 15px 0" />

        <div class="input-group">
          <label>üëÆ Contrase√±a de Administrador</label>
          <input
            type="password"
            id="anular-pass-admin"
            placeholder="Ingrese credencial de supervisor"
          />
        </div>

        <div style="display: flex; gap: 10px; margin-top: 15px">
          <button
            onclick="confirmarAnulacion()"
            class="btn-primary"
            style="background: #ef4444; margin: 0"
          >
            CONFIRMAR ANULACI√ìN
          </button>
          <button
            onclick="cerrarModal('modal-anulacion')"
            style="
              background: grey;
              color: white;
              border: none;
              padding: 10px;
              border-radius: 8px;
              width: 100%;
            "
          >
            Cancelar
          </button>
        </div>
      </div>
    </div>

    <div id="modal-perdida" class="modal">
      <div class="modal-content" style="width: 800px; max-height: 90vh">
        <div
          style="
            text-align: center;
            border-bottom: 2px solid var(--danger);
            padding-bottom: 10px;
            margin-bottom: 15px;
          "
        >
          <h2 style="color: var(--danger); margin: 0">üö® ACTA DE P√âRDIDA</h2>
          <span style="color: var(--text-muted); font-size: 0.9rem"
            >C√ìDIGO: <b id="loss-codigo">...</b></span
          >
        </div>

        <div
          style="
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            font-size: 0.85rem;
          "
        >
          <div>
            <label>CLIENTE</label>
            <div id="loss-cliente" style="font-weight: bold">...</div>
          </div>
          <div>
            <label>DNI/CE</label>
            <div id="loss-dni">...</div>
          </div>
          <div>
            <label>INGRESO</label>
            <div id="loss-ingreso">...</div>
          </div>
          <div>
            <label>VEH√çCULO</label>
            <div id="loss-tipo">...</div>
          </div>
          <div>
            <label>MARCA</label>
            <div id="loss-marca">...</div>
          </div>
          <div>
            <label>COLOR</label>
            <div id="loss-color">...</div>
          </div>
        </div>
        <h4
          style="
            margin: 15px 0 5px 0;
            color: #334155;
            border-bottom: 1px solid #eee;
          "
        >
          üìû Datos de Contacto y Entrega
        </h4>
        <div
          style="
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
          "
        >
          <div>
            <label style="font-size: 0.8rem; font-weight: bold">TEL√âFONO</label>
            <input
              type="text"
              id="loss-telefono"
              class="form-control"
              placeholder="Ej: 999..."
              autocomplete="off"
              style="width: 100%"
            />
          </div>
          <div>
            <label style="font-size: 0.8rem; font-weight: bold"
              >DIRECCI√ìN</label
            >
            <input
              type="text"
              id="loss-direccion"
              class="form-control"
              placeholder="Av. Siempre Viva 123"
              autocomplete="off"
              style="width: 100%"
            />
          </div>
          <div>
            <label style="font-size: 0.8rem; font-weight: bold">CORREO</label>
            <input
              type="text"
              id="loss-correo"
              class="form-control"
              placeholder="correo@ejemplo.com"
              autocomplete="off"
              style="width: 100%"
            />
          </div>
        </div>

        <h4 style="margin: 15px 0 5px 0">üì∏ Evidencia Fotogr√°fica</h4>
        <div class="camera-container">
          <div class="video-box">
            <video id="video-feed" autoplay></video>
            <div
              style="
                position: absolute;
                bottom: 5px;
                width: 100%;
                display: flex;
                justify-content: center;
                gap: 5px;
              "
            >
              <button onclick="capturarFoto('anverso')" class="btn-cap">
                üì∏ ANVERSO DNI/CE
              </button>
              <button onclick="capturarFoto('reverso')" class="btn-cap">
                üì∏ REVERSO DNI/CE
              </button>
            </div>
          </div>
          <div class="photo-preview">
            <img id="img-anverso" style="display: none" />
            <img id="img-reverso" style="display: none" />
            <span
              id="placeholder-text"
              style="color: #94a3b8; font-size: 0.8rem"
              >Capture las evidencias</span
            >
          </div>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px">
          <button
            onclick="generarActaSalida()"
            class="btn-primary"
            style="background: var(--danger); flex: 2"
          >
            üìù GENERAR ACTA Y SALIDA
          </button>
          <button
            onclick="cerrarModal('modal-perdida')"
            class="btn-primary"
            style="background: grey; flex: 1"
          >
            CANCELAR
          </button>
        </div>
        <input type="hidden" id="loss-id-ticket" />
      </div>
    </div>

    <div id="modal-usuarios" class="modal">
      <div class="modal-content" style="width: 500px">
        <h3>üë• Gesti√≥n de Usuarios</h3>
        <div class="input-group">
          <label>Nombre</label><input type="text" id="new-nombre" />
        </div>
        <div class="input-group">
          <label>Usuario</label><input type="text" id="new-user" />
        </div>
        <div class="input-group">
          <label>Contrase√±a</label><input type="password" id="new-pass" />
        </div>
        <div class="input-group">
          <label>Rol</label
          ><select id="new-rol">
            <option value="Empleado">Empleado</option>
            <option value="Administrador">Administrador</option>
          </select>
        </div>
        <button
          onclick="crearUsuario()"
          class="btn-primary"
          style="margin-top: 15px"
        >
          Crear Usuario
        </button>
        <hr style="margin: 20px 0; border: 0.5px solid #eee" />
        <div style="max-height: 150px; overflow-y: auto">
          <table style="width: 100%">
            <tbody id="lista-usuarios-body"></tbody>
          </table>
        </div>
        <button
          onclick="cerrarModal('modal-usuarios')"
          style="
            background: grey;
            color: white;
            width: 100%;
            margin-top: 15px;
            border: none;
            padding: 10px;
            border-radius: 8px;
          "
        >
          Cerrar
        </button>
      </div>
    </div>

    <div id="modal-historial" class="modal">
      <div class="modal-content" style="width: 950px">
        <h3>üìú Historial del Turno</h3>

        <input
          type="text"
          id="filtro-historial"
          placeholder="üîç Buscar por nombre, c√≥digo o veh√≠culo..."
          oninput="filtrarHistorial()"
          style="
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
          "
        />

        <div style="max-height: 450px; overflow-y: auto">
          <table>
            <thead>
              <tr>
                <th>Estado</th>
                <th>C√≥digo</th>
                <th>Cliente</th>
                <th>Veh√≠culo</th>
                <th>Entrada</th>
                <th>Salida</th>
              </tr>
            </thead>
            <tbody id="historial-body"></tbody>
          </table>
        </div>
        <button
          onclick="cerrarModal('modal-historial')"
          style="
            background: grey;
            color: white;
            width: 100%;
            margin-top: 15px;
            border: none;
            padding: 12px;
            border-radius: 8px;
          "
        >
          Cerrar
        </button>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="../js/dashboard.js"></script>
  </body>
</html>
